---
# task/configure file for hashicorp_nomad
- name: "Ensure default nomad.hcl is removed"
  ansible.builtin.file:
    path: /etc/nomad.d/nomad.hcl
    state: absent

- name: "Copy nomad.json template"
  ansible.builtin.template:
    src: nomad.json.j2
    dest: "{{ hashicorp_nomad_config_dir }}/nomad.json"
    owner: "{{ hashicorp_nomad_user }}"
    group: "{{ hashicorp_nomad_group }}"
    mode: "0600"
  notify:
    - "systemctl-enable-nomad"
    - "systemctl-restart-nomad"

- name: "Create nomad.env"
  ansible.builtin.template:
    src: nomad.env.j2
    dest: "{{ hashicorp_nomad_config_dir }}/nomad.env"
    owner: "{{ hashicorp_nomad_user }}"
    group: "{{ hashicorp_nomad_group }}"
    mode: "0600"

- name: "Copy extra configuration files"
  when: hashicorp_nomad_extra_files
  block:
    - name: "Create directory {{ hashicorp_nomad_extra_files_dst }}"
      ansible.builtin.file:
        path: "{{ hashicorp_nomad_extra_files_dst }}"
        state: directory
        owner: "{{ hashicorp_nomad_user }}"
        group: "{{ hashicorp_nomad_group }}"
        mode: "0755"

    - name: "Copy extra configuration files"
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "{{ hashicorp_nomad_extra_files_dst }}/{{ (item | basename).split('.')[:-1] | join('.')}}"
        owner: "{{ hashicorp_nomad_user }}"
        group: "{{ hashicorp_nomad_group }}"
        mode: "0600"
      with_fileglob:
        - "{{ hashicorp_nomad_extra_files_src }}/*"
